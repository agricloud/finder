{
    "type": "Ext.panel.Panel",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "container|align": "stretch",
        "height": null,
        "itemId": "batchViewer",
        "margin": null,
        "designer|userClassName": "BatchViewer",
        "designer|userAlias": "batchviewer",
        "layout": "vbox",
        "title": ""
    },
    "designerId": "f579f8e9-4abc-4c82-8d98-5113a7d3d33e",
    "cn": [
        {
            "type": "Ext.form.Panel",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "layout|flex": null,
                "container|align": "stretch",
                "container|padding": 10,
                "itemId": "batchForm",
                "designer|displayName": "batchForm",
                "layout": "vbox",
                "title": "",
                "jsonSubmit": true
            },
            "designerId": "da7c348c-bddf-4435-adc1-d26632bc2317",
            "cn": [
                {
                    "type": "Ext.form.field.Number",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "layout|flex": 1,
                        "itemId": "id",
                        "fieldLabel": "id",
                        "name": "id",
                        "readOnly": true
                    },
                    "designerId": "e53dd3f7-9392-4286-b860-c167bb019168"
                },
                {
                    "type": "Ext.form.field.Text",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "itemId": "name",
                        "designer|displayName": "name",
                        "fieldLabel": "name",
                        "name": "name",
                        "allowBlank": false
                    },
                    "designerId": "604c3cdc-7dca-4257-beed-5fbc9149eb43"
                },
                {
                    "type": "Ext.form.field.Date",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "layout|flex": 1,
                        "itemId": "dueDate",
                        "fieldLabel": "dueDate",
                        "name": "dueDate"
                    },
                    "designerId": "d2f0561c-074a-4a47-bd11-25fd6f7f1d74"
                },
                {
                    "type": "Ext.form.field.Number",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "layout|flex": 1,
                        "itemId": "expectQty",
                        "fieldLabel": "expectQty",
                        "name": "expectQty",
                        "allowBlank": false
                    },
                    "designerId": "f56f64a8-fb31-4092-8d55-9b530b0c10b7"
                },
                {
                    "type": "Ext.form.field.ComboBox",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "layout|flex": 1,
                        "itemId": "item_id",
                        "designer|displayName": "",
                        "fieldLabel": "item_id",
                        "name": "item_id",
                        "allowBlank": false,
                        "editable": false,
                        "displayField": "id",
                        "forceSelection": true,
                        "store": "ItemStore",
                        "valueField": "id"
                    },
                    "designerId": "04bc0f92-7f69-4a17-8183-caff3cdce5c2"
                }
            ]
        },
        {
            "type": "Ext.tab.Panel",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "layout|flex": 1,
                "height": 2,
                "itemId": "BatchExtendTab",
                "activeTab": 0
            },
            "designerId": "c2c19a3d-f7a0-44dc-8a8a-08475b47c6ab",
            "cn": [
                {
                    "type": "Ext.panel.Panel",
                    "reference": {
                        "name": "items",
                        "type": "array"
                    },
                    "codeClass": null,
                    "userConfig": {
                        "title": "批號途程"
                    },
                    "designerId": "bfdf137f-541c-4492-9c9c-00dc77b0a119",
                    "cn": [
                        {
                            "type": "Ext.tab.Tab",
                            "reference": {
                                "name": "tabConfig",
                                "type": "object"
                            },
                            "codeClass": null,
                            "designerId": "c38d0937-6e93-4ffd-b71c-e60f28c4dcd6"
                        },
                        {
                            "type": "Ext.grid.Panel",
                            "reference": {
                                "name": "items",
                                "type": "array"
                            },
                            "codeClass": null,
                            "userConfig": {
                                "height": 250,
                                "itemId": "batchRouteGrid",
                                "width": null,
                                "title": null,
                                "store": "BatchRouteStore"
                            },
                            "designerId": "083c93bf-e8b4-4eae-a9e8-0fccaeef35ea",
                            "cn": [
                                {
                                    "type": "Ext.toolbar.Toolbar",
                                    "reference": {
                                        "name": "dockedItems",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "initialize": null,
                                        "dock": "top",
                                        "itemId": "stdEditorToolbar1"
                                    },
                                    "configAlternates": {
                                        "initialize": "object"
                                    },
                                    "designerId": "6aa5addf-9fe2-46e8-97b2-57ecc2d44330",
                                    "customConfigs": [
                                        {
                                            "group": "(Custom Properties)",
                                            "name": "initialize",
                                            "type": "string"
                                        }
                                    ],
                                    "cn": [
                                        {
                                            "type": "Ext.button.Button",
                                            "reference": {
                                                "name": "items",
                                                "type": "array"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "layout|flex": null,
                                                "itemId": "createBtn2",
                                                "text": "Create"
                                            },
                                            "designerId": "1be99b04-7f28-433c-a938-2a1862acb572",
                                            "cn": [
                                                {
                                                    "type": "fixedfunction",
                                                    "reference": {
                                                        "name": "items",
                                                        "type": "array"
                                                    },
                                                    "codeClass": null,
                                                    "userConfig": {
                                                        "fn": "handler",
                                                        "designer|params": [
                                                            "button",
                                                            "event"
                                                        ],
                                                        "implHandler": [
                                                            "var grid = this.up().up();",
                                                            "var store = grid.getStore();",
                                                            "var form = grid.up().up().up().down('form[itemId=batchForm]');",
                                                            "var id = form.down('numberfield[name=id]').getRawValue();",
                                                            "var data = {",
                                                            "    id:'',",
                                                            "    'batch.id':id,",
                                                            "    'workstation.id':'',",
                                                            "    'operation.id':'',",
                                                            "    sequence:store.getCount()+1",
                                                            "};",
                                                            "store.insert(store.getCount(),data);"
                                                        ]
                                                    },
                                                    "designerId": "619e5419-b3c9-4a60-87ee-0dc8ff69d9d1"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "Ext.button.Button",
                                            "reference": {
                                                "name": "items",
                                                "type": "array"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "layout|flex": null,
                                                "itemId": "deleteBtn2",
                                                "text": "Delete"
                                            },
                                            "designerId": "288bbffd-d371-4f63-8514-5b6fa357b412",
                                            "cn": [
                                                {
                                                    "type": "fixedfunction",
                                                    "reference": {
                                                        "name": "items",
                                                        "type": "array"
                                                    },
                                                    "codeClass": null,
                                                    "userConfig": {
                                                        "fn": "handler",
                                                        "designer|params": [
                                                            "button",
                                                            "event"
                                                        ],
                                                        "implHandler": [
                                                            "var grid = this.up().up();",
                                                            "var sm = grid.getSelectionModel();",
                                                            "",
                                                            "editPlugin = grid.getPlugin('batchRouteEditPlugin');",
                                                            "editPlugin.cancelEdit();",
                                                            "",
                                                            "store=grid.getStore();",
                                                            "store.remove(sm.getSelection());"
                                                        ]
                                                    },
                                                    "designerId": "22aa9343-3e4e-4d56-a5bb-1d33eee9528c"
                                                }
                                            ]
                                        },
                                        {
                                            "type": "Ext.button.Button",
                                            "reference": {
                                                "name": "items",
                                                "type": "array"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "layout|flex": null,
                                                "itemId": "saveBtn2",
                                                "text": "Save"
                                            },
                                            "designerId": "83d26224-30e4-47cc-8c3b-08928175835e",
                                            "cn": [
                                                {
                                                    "type": "fixedfunction",
                                                    "reference": {
                                                        "name": "items",
                                                        "type": "array"
                                                    },
                                                    "codeClass": null,
                                                    "userConfig": {
                                                        "fn": "handler",
                                                        "designer|params": [
                                                            "button",
                                                            "event"
                                                        ],
                                                        "implHandler": [
                                                            "var grid = this.up().up();",
                                                            "var editPlugin=grid.getPlugin('batchRouteEditPlugin');",
                                                            "editPlugin.completeEdit();",
                                                            "",
                                                            "var form = grid.up().up().up().down('form');",
                                                            "var id = form.down('numberfield[name=id]').getValue();",
                                                            "var store = grid.getStore();",
                                                            "store.sync({",
                                                            "    url: '/rest/batchRoute',",
                                                            "    waitMsg: 'Saving Data...',",
                                                            "    success: function() {",
                                                            "        console.log('Saving Success！');",
                                                            "        Ext.MessageBox.alert('Success','資料更新完成');",
                                                            "        store.data.clear();",
                                                            "        store.load({",
                                                            "            params:{'batch.id':id}",
                                                            "        });",
                                                            "    },",
                                                            "    failure: function() {",
                                                            "        console.log('Saving Failed！');",
                                                            "    }",
                                                            "});"
                                                        ]
                                                    },
                                                    "designerId": "3a10ceaa-e8e0-4229-972e-e9c6c38a420c"
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.grid.View",
                                    "reference": {
                                        "name": "viewConfig",
                                        "type": "object"
                                    },
                                    "codeClass": null,
                                    "designerId": "175a3ae2-16f4-47f1-acb5-dfeab03576f4"
                                },
                                {
                                    "type": "Ext.grid.column.Column",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "id",
                                        "text": "Id"
                                    },
                                    "designerId": "6a6f0213-6da2-43fe-b7f3-6dc75855531c"
                                },
                                {
                                    "type": "Ext.grid.column.Column",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "batch.id",
                                        "text": "Batch"
                                    },
                                    "designerId": "f2cf0f53-d8d6-4b8c-b640-6ec0ade5663a",
                                    "cn": [
                                        {
                                            "type": "Ext.form.field.ComboBox",
                                            "reference": {
                                                "name": "editor",
                                                "type": "object"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "editable": false,
                                                "displayField": "title",
                                                "hiddenName": null,
                                                "store": "BatchStore",
                                                "valueField": "id"
                                            },
                                            "designerId": "34a5b8c5-cf11-4236-81a2-8b2d1cb55d6e"
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.grid.column.Column",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "workstation.id",
                                        "text": "Workstation"
                                    },
                                    "designerId": "3262793e-95b5-437f-b374-d64c3daa892d",
                                    "cn": [
                                        {
                                            "type": "Ext.form.field.ComboBox",
                                            "reference": {
                                                "name": "editor",
                                                "type": "object"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "editable": false,
                                                "displayField": "title",
                                                "hiddenName": null,
                                                "store": "WorkstationStore",
                                                "valueField": "id"
                                            },
                                            "designerId": "c92e6de1-e7cb-4175-9592-4cb12f4adc1a"
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.grid.column.Column",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "operation.id",
                                        "text": "Operation"
                                    },
                                    "designerId": "03a86f7b-159f-4816-b850-436b807e67a1",
                                    "cn": [
                                        {
                                            "type": "Ext.form.field.ComboBox",
                                            "reference": {
                                                "name": "editor",
                                                "type": "object"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "editable": false,
                                                "displayField": null,
                                                "hiddenName": null,
                                                "store": null,
                                                "valueField": null
                                            },
                                            "designerId": "a697d69a-938a-4c54-b558-f5e15b26d622"
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.grid.column.Number",
                                    "reference": {
                                        "name": "columns",
                                        "type": "array"
                                    },
                                    "codeClass": null,
                                    "userConfig": {
                                        "dataIndex": "sequence",
                                        "text": "Sequence",
                                        "format": "0000"
                                    },
                                    "designerId": "df51dcb1-7b82-4f32-bdcd-f77859821f2d",
                                    "cn": [
                                        {
                                            "type": "Ext.form.field.Number",
                                            "reference": {
                                                "name": "editor",
                                                "type": "object"
                                            },
                                            "codeClass": null,
                                            "designerId": "d3357091-20ec-4d0e-a1f4-93742457ea12"
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.grid.plugin.RowEditing",
                                    "reference": {
                                        "name": "plugins",
                                        "type": "array"
                                    },
                                    "codeClass": "Ext.grid.plugin.RowEditing",
                                    "userConfig": {
                                        "pluginId": "batchRouteEditPlugin"
                                    },
                                    "designerId": "f473bc86-a206-4f6a-9052-5e79dc441235",
                                    "cn": [
                                        {
                                            "type": "basiceventbinding",
                                            "reference": {
                                                "name": "listeners",
                                                "type": "array"
                                            },
                                            "codeClass": null,
                                            "userConfig": {
                                                "fn": "onRowEditingEdit1",
                                                "implHandler": [
                                                    "var grid = this.down('gridpanel[itemId=itemRouteGrid]');",
                                                    "var sm = grid.getSelectionModel();",
                                                    "var store = grid.getStore();",
                                                    "var models = store.getRange();",
                                                    "var activeRow = context.rowIdx; // 從0起算",
                                                    "",
                                                    "if (activeRow+1 != store.getAt(activeRow).get('sequence')){",
                                                    "    var totalRow = store.getCount(); // 從1起算",
                                                    "    var itemId = store.getAt(activeRow).get('item.id');",
                                                    "    var itemSequence = store.getAt(activeRow).get('sequence');",
                                                    "    if (itemSequence < activeRow+1){ // 插入後，其他途程下移調整",
                                                    "        for (var j = itemSequence-1; j < activeRow; j++){",
                                                    "            models[j].set('sequence', j+2);",
                                                    "        }",
                                                    "    }",
                                                    "    else if (itemSequence > activeRow+1){ // 插入後，其他途程上移調整",
                                                    "        for(var k = activeRow+1; k < totalRow; k++){",
                                                    "            models[k].set('sequence', k);",
                                                    "        }",
                                                    "    }",
                                                    "    models[activeRow].set('sequence', Math.min(totalRow,itemSequence));",
                                                    "    store.sort();",
                                                    "}"
                                                ],
                                                "name": "edit",
                                                "scope": "me"
                                            },
                                            "designerId": "00b20166-8ad3-426f-9680-b75bcc20aac8"
                                        }
                                    ]
                                },
                                {
                                    "type": "Ext.selection.RowModel",
                                    "reference": {
                                        "name": "selModel",
                                        "type": "object"
                                    },
                                    "codeClass": "Ext.selection.RowModel",
                                    "designerId": "e6d02319-db52-45f3-9d34-a3679165ed55"
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}